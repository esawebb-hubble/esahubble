<IfDefine !maintenance>
  DocumentRoot        {{ROOT}}/docs
</IfDefine>

<IfDefine maintenance>
  DocumentRoot        {{ROOT}}/docs_maintenance
</IfDefine>

{% for HOST, INTERFACE, IP in WEBSERVERS %}
<IfDefine http.{{SHORT_NAME}}.main.{{HOST}}>
  ServerName        {{INTERFACE}}.hq.eso.org
  Listen            {{IP}}:80
</IfDefine>
<IfDefine http.{{SHORT_NAME}}.static.{{HOST}}>
  ServerName        {{INTERFACE}}.hq.eso.org
  Listen            {{IP}}:81
</IfDefine>
<IfDefine SSL>
  <IfDefine http.{{SHORT_NAME}}.main.{{HOST}}>
    Listen {{IP}}:443
  </IfDefine>
  <IfDefine http.{{SHORT_NAME}}.static.{{HOST}}>
    Listen {{IP}}:4443
  </IfDefine>
</IfDefine>
{% endfor %}

<IfDefine tkt>
  LoadModule auth_tkt_module modules/mod_auth_tkt.so
  TKTAuthSecret "{{SECRET_KEY}}"
</IfDefine>

<IfDefine !maintenance>
<IfDefine !static>
  # Main server only serves one HTML page per user request. Static images is downloaded
  # from static server instead, so don't keep the connection open 
  KeepAlive Off

  SetEnv DJANGO_SETTINGS_MODULE {{SETTINGS_MODULE}}
  SetEnv DJANGOPLICITY_SETTINGS {{LOCAL_SETTINGS_MODULE}}
  SetEnv PYTHON_EGG_CACHE "/home/web/admin/logs/http.{{SHORT_NAME}}.main/pythoneggs"

  <IfDefine modwsgi>
    WSGIDaemonProcess eso user=http group=websys threads=30
    WSGIProcessGroup eso
    WSGIPythonHome {{ROOT}}/virtualenv
    WSGIScriptAlias / {{ROOT}}/virtualenv/apache/django.wsgi
    <Directory {{ROOT}}/virtualenv/apache>
      Order deny,allow
      Allow from all
    </Directory>
  </IfDefine>

{% if WEBSERVERS %}
  # Process requests to {{MEDIA_URL}} in case main server is
  # accessed directly. 
  <IfModule proxy_module>
    ProxyRequests Off

    <Proxy *>
      Order deny,allow
      Allow from all
    </Proxy>

    <Location "{{MEDIA_URL}}">
      SetHandler None
    </Location>

{% for HOST, INTERFACE, IP in WEBSERVERS %}
    <IfDefine http.{{SHORT_NAME}}.main.{{HOST}}>
      ProxyPass {{MEDIA_URL}} http://{{INTERFACE}}.hq.eso.org:81{{MEDIA_URL}}
      ProxyPassReverse {{MEDIA_URL}} http://{{SHORT_NAME}}1i.hq.eso.org:81{{MEDIA_URL}}
    </IfDefine>
{% endfor %}
  </IfModule>
{% endif %}
</IfDefine>
</IfDefine>

<IfDefine SSL>
  LogLevel error
  Include config/extra/httpd-ssl.conf
  
  <IfDefine main>
    <VirtualHost _default_:443>
      SSLProtocol All
      SSLEngine On

      ErrorLog    logs/errors
      TransferLog logs/access

      SSLCertificateFile    ssl.crt/{{SSL_ASSETS_PREFIX}}.crt
      SSLCertificateKeyFile ssl.key/{{SSL_ASSETS_PREFIX}}.key
      SSLCACertificateFile  ssl.crt/dfn-eso-ca.crt 
      SSLCertificateChainFile ssl.crt/dfn-chain.txt
    </VirtualHost>
  </IfDefine>  
</IfDefine>
