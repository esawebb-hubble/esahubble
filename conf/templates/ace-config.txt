#
# Real servers
#
{% for HOST, INTERFACE, IP, TYPE in WEBSERVERS %}rserver host {{INTERFACE|upper}}_REAL
  description {{INTERFACE|upper}}
  ip address {{IP}}
  inservice
{% endfor %}
#
# Server farms
#
serverfarm host {{SHORT_NAME|upper}}_HTTPS_SF
  description https://{{SHORT_NAME}}.hq.eso.org/*
  predictor leastconns
  probe HTTPS_PROBE
  probe Ping_Probe
{% for HOST, INTERFACE, IP, TYPE in WEBSERVERS %}  rserver {{INTERFACE|upper}}_REAL 443
    inservice
{% endfor %}serverfarm host {{SHORT_NAME|upper}}_HTTPS_STATIC_SF
  description https://{{SHORT_NAME}}.hq.eso.org/static/*
  predictor leastconns
  probe HTTPS_4443_PROBE
  probe Ping_Probe
{% for HOST, INTERFACE, IP, TYPE in WEBSERVERS %}  rserver {{INTERFACE|upper}}_REAL 4443
    inservice
{% endfor %}serverfarm host {{SHORT_NAME|upper}}_SF
  description http://{{SHORT_NAME}}.hq.eso.org/*
  predictor leastconns
  probe HTTP_PROBE
  probe Ping_Probe
{% for HOST, INTERFACE, IP, TYPE in WEBSERVERS %}  rserver {{INTERFACE|upper}}_REAL 80
    inservice
{% endfor %}serverfarm host {{SHORT_NAME|upper}}_STATIC_SF
  description http://{{SHORT_NAME}}.hq.eso.org/static/*
  predictor leastconns
  probe HTTP_81_PROBE
  probe Ping_Probe
{% for HOST, INTERFACE, IP, TYPE in WEBSERVERS %}  rserver {{INTERFACE|upper}}_REAL 81
    inservice
{% endfor %}
#
# SSL proxy
#
ssl-proxy service {{SHORT_NAME|upper}}_SSL_PROXY
  key {{SHORT_NAME|upper}}_KEY
  cert {{SHORT_NAME|upper}}_CERT
  chaingroup DT_DFN_ESO_CHAIN
  ssl advanced-options ESO_SSL_PARAMETER_MAP

#
# URL maps
#   
class-map type http loadbalance match-any HTTP_STATIC_CLASS_MAP
  2 match http url /static/.*

#
# Virtual IPs
#  
class-map match-all {{SHORT_NAME|upper}}_HTTPS_VIP
  2 match virtual-address 134.171.75.2 tcp eq https
  
class-map match-all {{SHORT_NAME|upper}}_VIP
  2 match virtual-address 134.171.75.2 tcp eq www
  
policy-map type loadbalance first-match {{SHORT_NAME|upper}}_HTTPS_VIP-l7slb
  class HTTP_STATIC_CLASS_MAP
    serverfarm {{SHORT_NAME|upper}}_HTTPS_STATIC_SF backup WMAINT_SF
    ssl-proxy client CLIENT_SSL_PROXY
  class class-default
    serverfarm {{SHORT_NAME|upper}}_HTTPS_SF backup WMAINT_SF
    ssl-proxy client CLIENT_SSL_PROXY

policy-map type loadbalance first-match {{SHORT_NAME|upper}}_VIP-l7slb
  class HTTP_STATIC_CLASS_MAP
    serverfarm {{SHORT_NAME|upper}}_STATIC_SF backup WMAINT_SF
  class class-default
    serverfarm {{SHORT_NAME|upper}}_SF backup WMAINT_SF
    
policy-map multi-match int750
  class {{SHORT_NAME|upper}}_VIP
    loadbalance vip inservice
    loadbalance policy {{SHORT_NAME|upper}}_VIP-l7slb
    loadbalance vip icmp-reply active
    connection advanced-options WAN_WINDOW_SCALE_7_MAP
  class {{SHORT_NAME|upper}}_HTTPS_VIP
    loadbalance vip inservice
    loadbalance policy {{SHORT_NAME|upper}}_HTTPS_VIP-l7slb
    loadbalance vip icmp-reply active
    ssl-proxy server {{SHORT_NAME|upper}}_SSL_PROXY
    connection advanced-options WAN_WINDOW_SCALE_7_MAP